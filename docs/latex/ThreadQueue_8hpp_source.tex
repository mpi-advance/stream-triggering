\doxysection{Thread\+Queue.\+hpp}
\hypertarget{ThreadQueue_8hpp_source}{}\label{ThreadQueue_8hpp_source}\index{source/core/include/queues/ThreadQueue.hpp@{source/core/include/queues/ThreadQueue.hpp}}
\mbox{\hyperlink{ThreadQueue_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#ifndef\ ST\_THREAD\_QUEUE}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#define\ ST\_THREAD\_QUEUE}}
\DoxyCodeLine{00003\ }
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <atomic>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ <map>}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <mutex>}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <queue>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <thread>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <tuple>}}
\DoxyCodeLine{00010\ }
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bundle_8hpp}{abstract/bundle.hpp}}"{}}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{entry_8hpp}{abstract/entry.hpp}}"{}}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{match_8hpp}{abstract/match.hpp}}"{}}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{queue_8hpp}{abstract/queue.hpp}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{bool}\ isSerialized>}
\DoxyCodeLine{00017\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classThreadQueue}{ThreadQueue}}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classQueue}{Queue}}}
\DoxyCodeLine{00018\ \{}
\DoxyCodeLine{00019\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00020\ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{classQueueEntry}{InternalRequest}}\ =\ \mbox{\hyperlink{classQueueEntry}{QueueEntry}};}
\DoxyCodeLine{00021\ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{classThreadQueue_aec229fe883972faf840eff8bee71e106}{UserRequest}}\ \ \ \ \ =\ std::shared\_ptr<Request>;}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \ \ \ \ \mbox{\hyperlink{classThreadQueue_ac60400a47ddd1475725643210852c63c}{ThreadQueue}}()\ :\ \mbox{\hyperlink{classThreadQueue_a8e41c7e032d3de3c8c5400aaf0c07b5a}{thr}}(\&\mbox{\hyperlink{classThreadQueue}{ThreadQueue}}::\mbox{\hyperlink{classThreadQueue_aa366b861e87f9a8911c9f52caa6200a1}{progress}},\ \mbox{\hyperlink{classThreadQueue}{this}})}
\DoxyCodeLine{00024\ \ \ \ \ \{}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacePrint_af1ff8d85f2ff4ac7381b18677d35694a}{Print::out}}(\textcolor{stringliteral}{"{}Thread\ Queue\ init-\/ed"{}});}
\DoxyCodeLine{00026\ \ \ \ \ \}}
\DoxyCodeLine{00027\ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a77520ba49056e796d84dc8c68b1f9ade}{\string~ThreadQueue}}()}
\DoxyCodeLine{00028\ \ \ \ \ \{}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_ae49f73caa490ec861724c93212970222}{shutdown}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a8e41c7e032d3de3c8c5400aaf0c07b5a}{thr}}.join();}
\DoxyCodeLine{00031\ \ \ \ \ \}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classThreadQueue_aa89e066075b0e33f401b0327791aa3ef}{enqueue\_operation}}(\mbox{\hyperlink{classThreadQueue_aec229fe883972faf840eff8bee71e106}{UserRequest}}\ \mbox{\hyperlink{classThreadQueue}{request}})\textcolor{keyword}{\ override}}
\DoxyCodeLine{00034\ \textcolor{keyword}{\ \ \ \ }\{}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classThreadQueue}{request\_id}}\ =\ \mbox{\hyperlink{classThreadQueue}{request}}-\/>getID();}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classThreadQueue_ab96aeb1376b4cc93434ecfe1623d288f}{request\_cache}}.contains(\mbox{\hyperlink{classThreadQueue}{request\_id}}))}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Also\ converts\ to\ InternalRequest}}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_ab96aeb1376b4cc93434ecfe1623d288f}{request\_cache}}.emplace(\mbox{\hyperlink{classThreadQueue}{request\_id}},\ \mbox{\hyperlink{classThreadQueue}{request}});}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a01422ecea2912e1b4993efa70548f852}{entries}}.\mbox{\hyperlink{classCommunication_1_1Bundle_a589a05010e5a6fe3e9299173bb9fde89}{add\_to\_bundle}}(\mbox{\hyperlink{classThreadQueue_ab96aeb1376b4cc93434ecfe1623d288f}{request\_cache}}.at(\mbox{\hyperlink{classThreadQueue}{request\_id}}));}
\DoxyCodeLine{00042\ \ \ \ \ \}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classThreadQueue_afd908300e0bea7f9f8e74e4c2f2297aa}{enqueue\_startall}}(std::vector<UserRequest>\ \mbox{\hyperlink{classThreadQueue}{requests}})\textcolor{keyword}{\ override}}
\DoxyCodeLine{00045\ \textcolor{keyword}{\ \ \ \ }\{}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\&\ \mbox{\hyperlink{classThreadQueue}{req}}\ :\ \mbox{\hyperlink{classThreadQueue_ac60400a47ddd1475725643210852c63c}{requests}})}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_aa89e066075b0e33f401b0327791aa3ef}{enqueue\_operation}}(\mbox{\hyperlink{classThreadQueue}{req}});}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00050\ \ \ \ \ \}}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classThreadQueue_a087e3105b674412bcfa57d9289436e54}{enqueue\_waitall}}()\textcolor{keyword}{\ override}}
\DoxyCodeLine{00053\ \textcolor{keyword}{\ \ \ \ }\{}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ std::scoped\_lock<std::mutex>\ \mbox{\hyperlink{classThreadQueue_ac60400a47ddd1475725643210852c63c}{incoming\_lock}}(\mbox{\hyperlink{classThreadQueue_adf92f9bbcd3ab79447dde5592f2d2e29}{queue\_guard}});}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Move\ Bundle\ (entries)\ to\ the\ queue\ of\ work}}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a49c2d9e769c0e573461a61aa3cb081ca}{pending}}.push(std::move(\mbox{\hyperlink{classThreadQueue_a01422ecea2912e1b4993efa70548f852}{entries}}));}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ one\ to\ busy\ counter}}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a016653d15f3bb0aa7bcb78d779eb0ab3}{busy}}\ +=\ 1;}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Remake\ entries}}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a01422ecea2912e1b4993efa70548f852}{entries}}\ =\ \mbox{\hyperlink{classCommunication_1_1Bundle}{Bundle}}();}
\DoxyCodeLine{00061\ \ \ \ \ \}}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classThreadQueue_a0d0deef67e38a8852ea857ef3c135782}{host\_wait}}()\textcolor{keyword}{\ override}}
\DoxyCodeLine{00064\ \textcolor{keyword}{\ \ \ \ }\{}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (\mbox{\hyperlink{classThreadQueue_a016653d15f3bb0aa7bcb78d779eb0ab3}{busy}}.load())}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Do\ nothing.}}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00069\ \ \ \ \ \}}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{comment}{//\ Thread\ control\ variables}}
\DoxyCodeLine{00073\ \ \ \ \ std::atomic<int>\ \mbox{\hyperlink{classThreadQueue_a016653d15f3bb0aa7bcb78d779eb0ab3}{busy}};}
\DoxyCodeLine{00074\ \ \ \ \ std::thread\ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a8e41c7e032d3de3c8c5400aaf0c07b5a}{thr}};}
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordtype}{bool}\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_ae49f73caa490ec861724c93212970222}{shutdown}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00076\ \ \ \ \ std::mutex\ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_adf92f9bbcd3ab79447dde5592f2d2e29}{queue\_guard}};}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \ \ \textcolor{comment}{//\ Bundle\ variables}}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{classThreadQueue_acadb7d14e6dc173ea598a8f3c95989be}{BundleIterator}}\ =\ std::vector<Bundle>::iterator;}
\DoxyCodeLine{00080\ \ \ \ \ \mbox{\hyperlink{classCommunication_1_1Bundle}{Bundle}}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a01422ecea2912e1b4993efa70548f852}{entries}};}
\DoxyCodeLine{00081\ \ \ \ \ std::queue<Bundle>\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a49c2d9e769c0e573461a61aa3cb081ca}{pending}};}
\DoxyCodeLine{00082\ \ \ \ \ std::map<size\_t,\ InternalRequest>\ \mbox{\hyperlink{classThreadQueue_ab96aeb1376b4cc93434ecfe1623d288f}{request\_cache}};}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classThreadQueue_aa366b861e87f9a8911c9f52caa6200a1}{progress}}()}
\DoxyCodeLine{00085\ \ \ \ \ \{}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (!\mbox{\hyperlink{classThreadQueue_ae49f73caa490ec861724c93212970222}{shutdown}})}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classThreadQueue_a016653d15f3bb0aa7bcb78d779eb0ab3}{busy}}\ >\ 0)}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classCommunication_1_1Bundle}{Bundle}}\ \mbox{\hyperlink{classThreadQueue}{the\_bundle}}\ =\ std::move(\mbox{\hyperlink{classThreadQueue_a49c2d9e769c0e573461a61aa3cb081ca}{pending}}.front());}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{\ \ \textcolor{comment}{//\ Scope\ of\ the\ lock}}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::scoped\_lock<std::mutex>\ \mbox{\hyperlink{classThreadQueue_ac60400a47ddd1475725643210852c63c}{incoming\_lock}}(\mbox{\hyperlink{classThreadQueue_adf92f9bbcd3ab79447dde5592f2d2e29}{queue\_guard}});}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a49c2d9e769c0e573461a61aa3cb081ca}{pending}}.pop();}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (\mbox{\hyperlink{classThreadQueue_ac60400a47ddd1475725643210852c63c}{isSerialized}})}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue}{the\_bundle}}.progress\_serial();}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue}{the\_bundle}}.progress\_all();}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThreadQueue_a016653d15f3bb0aa7bcb78d779eb0ab3}{busy}}-\/-\/;}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::this\_thread::yield();}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00111\ \ \ \ \ \}}
\DoxyCodeLine{00112\ \};}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
